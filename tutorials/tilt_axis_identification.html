<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tilt axis identification &mdash; tiltlib 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=2709fde1"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="&lt;no title&gt;" href="../api.html" />
    <link rel="prev" title="Zone axis alignment" href="zone_axis_alignment.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            tiltlib
          </a>
              <div class="version">
                0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../usage.html">Usage</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="basic_usage.html">Basic Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="zone_axis_alignment.html">Zone axis alignment</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Tilt axis identification</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Fabricating-data">Fabricating data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Load-your-data">Load your data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Fitness-function">Fitness function</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Performing-the-optimization">Performing the optimization</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../generated/tiltlib.html">tiltlib</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contribution.html">Contribute</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">tiltlib</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../usage.html">Usage</a></li>
      <li class="breadcrumb-item active">Tilt axis identification</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorials/tilt_axis_identification.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Tilt-axis-identification">
<h1>Tilt axis identification<a class="headerlink" href="#Tilt-axis-identification" title="Link to this heading"></a></h1>
<p>This notebook will show an example of how to identify the tilt axis of a sample holder, by means of a tilt series.</p>
<p>For this, you will need a tilt series of a sample, meaning the same sample scanned (and subsequently orientation mapped) at multiple different tilt angles.</p>
<p>For this tutorial, Orix’s example dataset will be used, artificially tilted and with some added noise. The noise is not meant to emulate the kind of orientation discrepancies expected from a real tilt series, but rather as a way to show a certain level of robustness.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import the necessary packages</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">orix.vector</span> <span class="kn">import</span> <span class="n">Vector3d</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">tiltlib</span>
</pre></div>
</div>
</div>
<section id="Fabricating-data">
<h2>Fabricating data<a class="headerlink" href="#Fabricating-data" title="Link to this heading"></a></h2>
<p>In this section, a tilt series is fabricated from one of Orix’s example datasets.</p>
<p>If you have your own tilt series, you can skip this section.</p>
<p>The fabricated data is tilted around an axis lying in the xy-plane, rotated 30 degrees from the x-axis. Noise is introduced to each map, in the form of an additional rotation of large magnitude for some pixels (speckling) and low magnitude for all pixels.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make some fake tilt series data</span>
<span class="kn">from</span> <span class="nn">orix.quaternion</span> <span class="kn">import</span> <span class="n">Rotation</span>
<span class="kn">from</span> <span class="nn">orix.data</span> <span class="kn">import</span> <span class="n">sdss_austenite</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># This is the raw data we will use</span>
<span class="n">raw_xmap</span> <span class="o">=</span> <span class="n">sdss_austenite</span><span class="p">(</span><span class="n">allow_download</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Arbitrarily choose the tilt axis direction. Should lie in or close to the xy-plane</span>
<span class="c1"># Here, we use the x-axis, rotated 50 degrees around z</span>
<span class="n">axis_direction</span> <span class="o">=</span> <span class="n">Vector3d</span><span class="o">.</span><span class="n">xvector</span><span class="p">()</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">Vector3d</span><span class="o">.</span><span class="n">zvector</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span>

<span class="c1"># Choose a couple tilt angles</span>
<span class="n">tilt_angles</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">]</span> <span class="c1"># degrees</span>

<span class="c1"># Make a couple xmaps at the different tilt angles</span>
<span class="n">xmaps</span> <span class="o">=</span> <span class="p">[</span><span class="n">raw_xmap</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tilt_angles</span><span class="p">]</span>
<span class="k">for</span> <span class="n">xmap</span><span class="p">,</span> <span class="n">tilt_angle</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xmaps</span><span class="p">,</span> <span class="n">tilt_angles</span><span class="p">):</span>

    <span class="c1"># Manually modify the rotations with a rotation</span>
    <span class="n">xmap</span><span class="o">.</span><span class="n">_rotations</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">*=</span> <span class="o">~</span><span class="n">Rotation</span><span class="o">.</span><span class="n">from_axes_angles</span><span class="p">(</span><span class="n">axis_direction</span><span class="p">,</span> <span class="n">tilt_angle</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Add some pixel noise to every scan, at different intervals</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
    <span class="n">xmap</span><span class="o">.</span><span class="n">_rotations</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">*=</span> <span class="n">Rotation</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">xmap</span><span class="o">.</span><span class="n">_rotations</span><span class="o">.</span><span class="n">shape</span><span class="p">)[</span><span class="n">s</span><span class="p">]</span>

    <span class="c1"># Introduce a slight variance to all pixels, with euler angles between -2 to 2 degrees</span>
    <span class="n">euler</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">xmap</span><span class="o">.</span><span class="n">_rotations</span><span class="o">.</span><span class="n">size</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">xmap</span><span class="o">.</span><span class="n">_rotations</span><span class="o">.</span><span class="n">size</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">xmap</span><span class="o">.</span><span class="n">_rotations</span><span class="o">.</span><span class="n">size</span><span class="p">),</span>
    <span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">xmap</span><span class="o">.</span><span class="n">_rotations</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">*=</span> <span class="n">Rotation</span><span class="o">.</span><span class="n">from_euler</span><span class="p">(</span><span class="n">euler</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">*</span><span class="n">xmap</span><span class="o">.</span><span class="n">_rotations</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Show the difference between the raw crystal map and the noisy tilt series</span>
<span class="kn">from</span> <span class="nn">orix.plot</span> <span class="kn">import</span> <span class="n">IPFColorKeyTSL</span>
<span class="n">key</span> <span class="o">=</span> <span class="n">IPFColorKeyTSL</span><span class="p">(</span><span class="n">raw_xmap</span><span class="o">.</span><span class="n">phases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">point_group</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">orientation2color</span><span class="p">(</span><span class="n">Rotation</span><span class="o">.</span><span class="n">from_euler</span><span class="p">(</span><span class="n">raw_xmap</span><span class="o">.</span><span class="n">get_map_data</span><span class="p">(</span><span class="s2">&quot;orientations&quot;</span><span class="p">),</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">False</span><span class="p">)))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Raw data&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">orientation2color</span><span class="p">(</span><span class="n">Rotation</span><span class="o">.</span><span class="n">from_euler</span><span class="p">(</span><span class="n">xmaps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_map_data</span><span class="p">(</span><span class="s2">&quot;orientations&quot;</span><span class="p">),</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">False</span><span class="p">)))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;0 degrees&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">orientation2color</span><span class="p">(</span><span class="n">Rotation</span><span class="o">.</span><span class="n">from_euler</span><span class="p">(</span><span class="n">xmaps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_map_data</span><span class="p">(</span><span class="s2">&quot;orientations&quot;</span><span class="p">),</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">False</span><span class="p">)))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;15 degrees&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(-0.5, 116.5, 99.5, -0.5)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_tilt_axis_identification_4_1.png" src="../_images/tutorials_tilt_axis_identification_4_1.png" />
</div>
</div>
</section>
<section id="Load-your-data">
<h2>Load your data<a class="headerlink" href="#Load-your-data" title="Link to this heading"></a></h2>
<p>In this section, you can load your data.</p>
<p>You need a couple <code class="docutils literal notranslate"><span class="pre">CrystalMap</span></code>s and the tilt angles at which the data was captured at.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Depending on how you saved your data, other loading methods might be more suitable</span>
<span class="kn">from</span> <span class="nn">orix.io</span> <span class="kn">import</span> <span class="n">load</span>

<span class="n">xmaps</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">load</span><span class="p">(</span><span class="s2">&quot;path_to_your_data/xmap_1.h5&quot;</span><span class="p">),</span>
    <span class="n">load</span><span class="p">(</span><span class="s2">&quot;path_to_your_data/xmap_2.h5&quot;</span><span class="p">),</span>
    <span class="n">load</span><span class="p">(</span><span class="s2">&quot;path_to_your_data/xmap_3.h5&quot;</span><span class="p">),</span>
    <span class="n">load</span><span class="p">(</span><span class="s2">&quot;path_to_your_data/xmap_4.h5&quot;</span><span class="p">),</span>
    <span class="p">]</span>
<span class="n">tilt_angles</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">]</span> <span class="c1"># degrees</span>
</pre></div>
</div>
</div>
<p>The tilt angles do not need to be in order, but the order must correspond to the order of the crystal maps.</p>
</section>
<section id="Fitness-function">
<h2>Fitness function<a class="headerlink" href="#Fitness-function" title="Link to this heading"></a></h2>
<p>To find which axis angle fits best, we need to quantify the fitness of an axis position. Here, we choose a metric based on finding the mean misorientation angle between scans, after tilting them all to 0 degrees around a given tilt axis. All pixels of all scans are compared across all possible combinations of scans. As a tilt physically moves the sample, the sample is not completely lined up pixel-wise for all combinations. If possible, the user should crop their data such that it lines up as
good as possible. An imperfect alignment of the scans is also fine, since only the lowest 1/3 misorientation angles will be considered for optimization. This selection mitigates the effects of misalignment, misindexation, and specling.</p>
<p>This fitness function is quite robust, as it compares all pixels throughout the entire scan, for all possible combinations of scans. However, this makes it rather slow. Other fitness functions may provide faster computations.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations</span>

<span class="k">def</span> <span class="nf">fitness</span><span class="p">(</span><span class="n">axis_angle</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
    <span class="c1"># Note the single input angle, as we assume the axis lies in the xy-plane, perpendicular to the optical axis.</span>

    <span class="n">axis_direction</span> <span class="o">=</span> <span class="n">Vector3d</span><span class="o">.</span><span class="n">xvector</span><span class="p">()</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">Vector3d</span><span class="o">.</span><span class="n">zvector</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">axis_angle</span><span class="p">))</span>

    <span class="n">samples</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">tiltlib</span><span class="o">.</span><span class="n">Sample</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">xmap</span><span class="p">,</span> <span class="n">angle</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xmaps</span><span class="p">,</span> <span class="n">tilt_angles</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">tiltlib</span><span class="o">.</span><span class="n">Sample</span><span class="o">.</span><span class="n">from_crystal_map</span><span class="p">(</span><span class="n">xmap</span><span class="p">,</span> <span class="p">[</span><span class="n">tiltlib</span><span class="o">.</span><span class="n">Axis</span><span class="p">(</span><span class="n">axis_direction</span><span class="p">,</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">True</span><span class="p">)])</span>
        <span class="n">s</span><span class="o">.</span><span class="n">rotate_to</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="n">misorientation_angles</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">sample_a</span><span class="p">,</span> <span class="n">sample_b</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>

        <span class="n">misorientation_angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample_a</span><span class="o">.</span><span class="n">orientations</span><span class="o">.</span><span class="n">angle_with</span><span class="p">(</span><span class="n">sample_b</span><span class="o">.</span><span class="n">orientations</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">misorientation_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">misorientation_angles</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="c1"># Choose the bottom third misorientation angles, as most of the large angles are probably due to noise / misindexation</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">misorientation_angles</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="mi">3</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="n">misorientation_angles</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)[:</span><span class="n">k</span><span class="p">])</span>
<br/></pre></div>
</div>
</div>
</section>
<section id="Performing-the-optimization">
<h2>Performing the optimization<a class="headerlink" href="#Performing-the-optimization" title="Link to this heading"></a></h2>
<p>At this point, using e.g. <code class="docutils literal notranslate"><span class="pre">scipy.optimize.minimize</span></code> should yield the tilt axis position. Additionally, we make a plot of the fitness score along a full rotation of axis positions, to show that the minima is indeed global.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
    <span class="n">fitness</span><span class="p">,</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="n">bounds</span><span class="o">=</span><span class="p">((</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">),),</span>
<span class="p">)</span>
<span class="n">res</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
  message: CONVERGENCE: NORM_OF_PROJECTED_GRADIENT_&lt;=_PGTOL
  success: True
   status: 0
      fun: 1.29038110723478
        x: [ 2.999e+01]
      nit: 6
      jac: [ 3.086e-06]
     nfev: 22
     njev: 11
 hess_inv: &lt;1x1 LbfgsInvHessProduct with dtype=float64&gt;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># We use tqdm to get a nice progress bar, as this is quite slow</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>
<span class="n">fitness_scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">fitness</span><span class="p">(</span><span class="n">ang</span><span class="p">)</span> <span class="k">for</span> <span class="n">ang</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">angles</span><span class="p">)]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Fitness score&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">fitness_scores</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Tilt axis position [deg]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Score&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|██████████| 180/180 [01:55&lt;00:00,  1.56it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0, 0.5, &#39;Score&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_tilt_axis_identification_12_2.png" src="../_images/tutorials_tilt_axis_identification_12_2.png" />
</div>
</div>
<p>From both the optimization and from manually inspecting the graph, we see the angle of the tilt axis with the x-axis is 30 degrees, as we set it to initially.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="zone_axis_alignment.html" class="btn btn-neutral float-left" title="Zone axis alignment" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../api.html" class="btn btn-neutral float-right" title="&lt;no title&gt;" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Viljar Femoen.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>